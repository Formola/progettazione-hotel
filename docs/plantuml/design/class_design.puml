@startuml class_design_final
left to right direction
skinparam classAttributeIconSize 0
skinparam linetype polyline
skinparam shadowing false

' --- API ---
class AuthApi {
    -service: AuthService
    +login(email: String, password: String): UserData
    +signup(user: UserData, password: String): UserData
    +logout(): void
    +getAccessToken(): String
    +getCurrentUser(): UserData
    +refreshSession(): String
    +isAuthenticated(): boolean
}

class PropertyApi {
    +createProperty(data: PropertyInput): PropertyData
    +getMyProperties(): PropertyData[]
    +getPropertyById(property_id: String): PropertyData
    +updateProperty(property_id: String, data: PropertyInput): PropertyData
    +deleteProperty(property_id: String): void
    +publishProperty(property_id: String): PropertyData
    +unpublishProperty(property_id: String): PropertyData
    +archiveProperty(property_id: String): PropertyData
    
    +getRoomsForProperty(property_id: String): RoomData[]
    +addRoomToProperty(property_id: String, data: RoomInput): RoomData

    +getAmenityCatalog(): PropertyAmenity[]
}

class RoomApi {
    +addRoom(property_id: String, data: RoomInput): RoomData
    +updateRoom(room_id: String, data: RoomInput): RoomData
    +deleteRoom(room_id: String): void

    +getAmenityCatalog(): RoomAmenity[]
}

class MediaApi {
    +uploadMedia(data: MediaInput): MediaData
    +deleteMedia(media_id: String): void
    +listByProperty(property_id: String): MediaData[]
}

class SearchApi {
    +searchProperties(criteria: SearchCriteria): PropertyData[]
    +getPropertyById(property_id: String): PropertyData
}

' --- SERVICES ---
class AuthService {
    -provider: IAuthProvider
    +login(email: String, password: String): UserData
    +signup(user: UserData, password: String): UserData
    +logout(): void
    +getAccessToken(): String
    +getUser(): UserData
    +refreshTokenOrLogout(): String
    -saveSession(response: AuthResponse): void
}

class PropertyService {
    -propertyRepo: PropertyRepository
    -amenityRepo: PropertyAmenityRepository
    -mediaRepo: MediaRepository
    -amenityFactory: PropertyAmenityFactory
    +get_user_properties(owner: User, owner_id: String): List<Property>
    +get_property_by_id(property_id: String): Property
    +create_property(data: PropertyInput, owner: User): Property
    +publish_property(property_id: String, owner: User): Property
    +unpublish_property(property_id: String, owner: User): Property
    +archive_property(property_id: String, owner: User): Property
    +delete_property(property_id: String, owner: User): void
    +update_property(property_id: String, data: PropertyInput): Property
}

class RoomService {
    -roomRepo: RoomRepository
    -propertyRepo: PropertyRepository
    -amenityRepo: RoomAmenityRepository
    -mediaRepo: MediaRepository
    -amenityFactory: RoomAmenityFactory
    +add_room(property_id: String, data: RoomInput): Room
    +get_room(room_id: String): Room
    +get_rooms_by_property_id(property_id: String): List<Room>
    +delete_room(room_id: String, owner: User): void
    +update_room(room_id: String, data: RoomInput, owner: User): Room
    +add_new_amenity(room_id: String, data: NewAmenityInput): Room
    +remove_room_amenity(room_id: String, amenity_id: String, owner: User): Room
}

class MediaService {
    -mediaRepo: MediaRepository
    -storage: IMediaStorage
    +upload_media(data: MediaInput): Media
    +delete_media(media_id: String): void
    +list_media_by_property(property_id: String): List<Media>
    +get_media_by_id(media_id: String): Media
    +list_media_by_room(room_id: String): List<Media>
    +list_all_media(): List<Media>
}

class SearchService {
    -searchRepo: SearchRepository
    +search(location: String): List<Dict>
}

' --- REPOSITORIES ---
class UserRepository {
    -db: Session
    +get_by_cognito_id(cognito_uuid: String): User
    +create_from_cognito(cognito_uuid: String, email: String, name: String): User
}

class PropertyRepository {
    -db: Session <<SQLAlchemy>>
    +save(entity: Property): Property
    +get_by_id(property_id: String): Property
    +get_by_owner_id(owner_id: String): List<Property>
    +delete(property_id: String): void
    - _sync_amenities(model: PropertyModel <<ORM>>, property_amenity_entities: List<PropertyAmenity>): void
    - _sync_room_amenities(room_model: RoomModel <<ORM>>, room_amenity_entities: List<RoomAmenity>): void
    - _sync_rooms_insert(model: PropertyModel <<ORM>>, room_entities: List<Room>): void
    - _sync_rooms_update(model: PropertyModel <<ORM>>, room_entities: List<Room>): void
    - _sync_media_insert(model: PropertyModel <<ORM>>, media_entities: List<Media>): void
    - _sync_media_update(model: PropertyModel <<ORM>>, media_entities: List<Media>): void
}

class RoomRepository {
    -db: Session <<SQLAlchemy>>
    +save(entity: Room): Room
    +get_by_id(room_id: String): Room
    +get_by_property_id(property_id: String): List<Room>
    +delete(room_id: String): void
    - _sync_amenities(room_model: RoomModel <<ORM>>, room_amenity_entities: List<RoomAmenity>): void
    - _sync_media(room_model: RoomModel <<ORM>>, media_entities: List<Media>): void
}

class MediaRepository {
    -db: Session
    +save(entity: Media, property_id: String, room_id: String): void
    +get_by_id(media_id: String): Media
    +list_by_property(property_id: String): List<Media>
    +list_by_room(room_id: String): List<Media>
    +delete(media_id: String): void
    +list_all(): List<Media>
}

class SearchRepository {
    -db: Session
    +search_properties(location: String): List<Dict>
}

abstract class AmenityRepository {
    +save(entity: IAmenity): IAmenity
    +delete(amenity_id: String): void
    +get_by_id(amenity_id: String): IAmenity
}

class PropertyAmenityRepository {
    -db: Session <<SQLAlchemy>>
    +save(entity: PropertyAmenity): PropertyAmenity
    +delete(amenity_id: String): void
    +get_by_id(amenity_id: String): PropertyAmenity
    +get_by_name(name: String): PropertyAmenity
}


class RoomAmenityRepository {
    -db: Session <<SQLAlchemy>>
    +save(entity: RoomAmenity): RoomAmenity
    +delete(amenity_id: String): void
    +get_by_id(amenity_id: String): RoomAmenity
    +get_by_name(name: String): RoomAmenity
}



' --- ENTITIES & DTOS ---
class User {
    +id: String
    +cognito_uuid: String
    +email: String
    +name: String
}

interface UserData {
    +id: String
    +email: String
    +role: String
}

interface AuthResponse {
    +access_token: String
    +refresh_token: String
    +id_token: String
    +user: UserData
}

class Property {
    +id: String
    +name: String
    +description: String
    +address: String
    +city: String
    +country: String
    +owner: User
    +status: PropertyStatus
    +amenities: List<PropertyAmenity>
    +rooms: List<Room>
    +media: List<Media>
    +publish(): void
    +can_be_published(): boolean
    +unpublish(): void
    +archive(): void
    +add_room(room: Room): void
    +remove_room(room_id: String): void
    +is_owned_by(user_id: String): boolean
    +add_amenity(property_amenity: PropertyAmenity, custom_description: String): void
}

class Room {
    +id: String
    +type: RoomType
    +price: float
    +capacity: int
    +property_id: String
    +description: String
    +is_available: boolean
    +amenities: List<RoomAmenity>
    +media: List<Media>
    +add_amenity(amenity: RoomAmenity, custom_description: String): void
    +remove_amenity(room_amenity_id: String): void
    +update_price(new_price: float): void
}

class Media {
    +id: String
    +file_name: String
    +storage_path: String
    +description: String
    +file_type: MediaType
}

interface IAmenity {
    +getName(): String
    +getCategory(): String
    +getDescription(): String
    +getCustomDescription(): String
}

class PropertyAmenity {
    +id: String
    +name: String
    +category: String
    +description: String
    +custom_description: String
    +getName(): String
    +getCategory(): String
    +getDescription(): String
    +getCustomDescription(): String
}

class RoomAmenity {
    +id: String
    +name: String
    +category: String
    +description: String
    +custom_description: String
    +getName(): String
    +getCategory(): String
    +getDescription(): String
    +getCustomDescription(): String
}

' --- INFRASTRUCTURE ---
interface IAuthProvider {
    +login(email: String, password: String): AuthResponse
    +signup(user: UserData, password: String): AuthResponse
    +refreshSession(refreshToken: String): AuthResponse
    +logout(): void
}

class AWSCognitoAuthProvider {
    -client: CognitoIdentityProviderClient({region: String, endpoint: String})
    -clientId: String
    -userPoolId: String
    +login(email: String, password: String): AuthResponse
    +signup(user: UserData, password: String): AuthResponse
    +refreshSession(refreshToken: String): AuthResponse
    +logout(): void
    -mapResponse(response: any): AuthResponse
}

interface IMediaStorage {
    +store_media(file_name: String, file_data: bytes, type: String): String
    +delete_media(storage_path: String): void
}

class S3MediaStorage {
    -s3_client: boto3.client('s3', region_name=String, endpoint_url=String)
    -bucket_name: String
    -settings: Settings
    +store_media(file_name: String, file_data: bytes, type: String): String
    +delete_media(storage_path: String): void
}

abstract class AmenityFactory {
    +create_amenity(id: String, name: String, category: String, description: String, custom_description: String): IAmenity
}

class PropertyAmenityFactory {
    +create_amenity(id: String, name: String, category: String, description: String, custom_description: String): PropertyAmenity
}

class RoomAmenityFactory {
    +create_amenity(id: String, name: String, category: String, description: String, custom_description: String): RoomAmenity
}


AuthApi --> AuthService
AuthService --> IAuthProvider
IAuthProvider <|.. AWSCognitoAuthProvider
AWSCognitoAuthProvider --> AuthResponse
AuthService --> UserData : uses
AuthService --> UserRepository
UserRepository --> User

' 2. PROPERTY FLOW 
PropertyApi ..> PropertyService
PropertyService --> PropertyRepository
PropertyRepository --> Property
PropertyService --> PropertyAmenityRepository
PropertyService --> PropertyAmenityFactory
PropertyService --> UserRepository

' 3. ROOM FLOW
RoomApi ..> RoomService
RoomService --> RoomRepository
RoomRepository --> Room
RoomService --> RoomAmenityRepository
RoomService --> RoomAmenityFactory
RoomService --> PropertyRepository
RoomService --> UserRepository

' 4. MEDIA FLOW
MediaApi ..> MediaService
MediaService --> MediaRepository
MediaRepository --> Media
MediaService --> IMediaStorage
MediaService --> UserRepository
IMediaStorage <|.. S3MediaStorage

' 5. SEARCH FLOW
SearchApi ..> SearchService
SearchService --> SearchRepository

' 6. ENTITY COMPOSITION & RELATIONS (Right Side)
Property "1" *-- "*" Room
Property "1" o-- "*" Media
Room "1" o-- "*" Media
Property --> User : owner
Property *-- PropertyAmenity
Room *-- RoomAmenity

' 7. INHERITANCE (Bottom/Detail)
AmenityRepository <|-- PropertyAmenityRepository
AmenityRepository <|-- RoomAmenityRepository
AmenityFactory <|-- PropertyAmenityFactory
AmenityFactory <|-- RoomAmenityFactory
IAmenity <|.. PropertyAmenity
IAmenity <|.. RoomAmenity

@enduml